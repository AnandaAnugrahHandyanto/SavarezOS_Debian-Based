#!/bin/sh
set -e

if [ -f /etc/calamares/settings.conf ]; then
    sed -i 's/branding: debian/branding: savarez/g' /etc/calamares/settings.conf
fi

cat <<EOF > /etc/os-release
PRETTY_NAME="SavarezOS GNU/Linux"
NAME="SavarezOS"
ID=savarezos
ID_LIKE=debian
HOME_URL="https://github.com/AnandaAnugrahHandyanto/SavarezOS_Debian-Based"
SUPPORT_URL="https://github.com/AnandaAnugrahHandyanto/SavarezOS_Debian-Based/issues"
LOGO="savarez-logo"
EOF

echo "SavarezOS-Alpha" > /etc/debian_version
echo "SavarezOS" > /etc/hostname

mkdir -p /usr/share/icons/hicolor/64x64/apps/
cp /usr/share/savarez/savarez-logo.png /usr/share/icons/hicolor/64x64/apps/savarez-logo.png
mkdir -p /etc/xdg
echo "[General]" > /etc/xdg/kcm-about-distrorc
echo "LogoPath=/usr/share/savarez/savarez-logo.png" >> /etc/xdg/kcm-about-distrorc

WP_SAVAREZ="/usr/share/savarez/savarez-wallpaper.png"

mkdir -p /usr/share/images/desktop-base
cp "$WP_SAVAREZ" /usr/share/images/desktop-base/default-wallpaper.png
cp "$WP_SAVAREZ" /usr/share/images/desktop-base/desktop-wallpaper

mkdir -p /usr/share/wallpapers/Next/contents/images/
for size in "1024x768" "1280x1024" "1600x1200" "1920x1080" "3840x2160"; do
    cp "$WP_SAVAREZ" "/usr/share/wallpapers/Next/contents/images/$size.png"
done
cp "$WP_SAVAREZ" /usr/share/wallpapers/Next/contents/images/base_size.png
rm -f /usr/share/wallpapers/Next/metadata.desktop

mkdir -p /usr/share/sddm/themes/debian-theme/
cp "$WP_SAVAREZ" /usr/share/sddm/themes/debian-theme/debian-background.png
if [ -f /usr/share/sddm/themes/debian-theme/theme.conf ]; then
    sed -i 's/Debian Live/SavarezOS Live/g' /usr/share/sddm/themes/debian-theme/theme.conf
    cp /usr/share/savarez/savarez-logo.png /usr/share/sddm/themes/debian-theme/logo.png
fi

mkdir -p /etc/skel/Desktop
mkdir -p /etc/skel/.config/autostart

if [ -f /usr/share/applications/install-savarezos.desktop ]; then
    chmod +x /usr/share/applications/install-savarezos.desktop
    cp /usr/share/applications/install-savarezos.desktop /etc/skel/Desktop/
fi

cat <<EOF > /etc/skel/.config/autostart/set-wallpaper.desktop
[Desktop Entry]
Type=Application
Name=Set Savarez Wallpaper
Exec=dbus-send --session --dest=org.kde.plasmashell --type=method_call /MainApplication org.kde.PlasmaShell.evaluateScript string:'var allDesktops = desktops(); for (var i = 0; i < allDesktops.length; i++) { d = allDesktops[i]; d.wallpaperPlugin = "org.kde.image"; d.currentConfigGroup = Array("Wallpaper", "org.kde.image", "General"); d.writeConfig("Image", "file:///usr/share/savarez/savarez-wallpaper.png"); }'
Icon=preferences-desktop-wallpaper
Terminal=false
NoDisplay=true
EOF

echo "SavarezOS GNU/Linux \n \l" > /etc/issue
echo "SavarezOS GNU/Linux \n \l" > /etc/issue.net
rm -f /usr/share/applications/install-debian.desktop